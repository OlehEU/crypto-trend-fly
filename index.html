<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crypto Trend — минималистичный веб</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --text:#e6eef8; --muted:#9fb0c8; --accent:#22c55e;
    }
    [data-theme="light"]{--bg:#f7fafc;--card:#ffffff;--text:#0b1220;--muted:#475569;--accent:#0ea5a0}
    html,body{height:100%; margin:0; font-family:Inter,Roboto,system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:1000px;margin:28px auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#3b82f6);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    select,input[type=text]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    button{padding:8px 10px;border-radius:8px;border:0;background:rgba(255,255,255,0.04);color:var(--text);cursor:pointer}
    .card{background:var(--card);border-radius:12px;padding:14px;margin-top:18px;box-shadow: 0 6px 18px rgba(2,6,23,0.6)}
    .topline{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .metrics{display:flex;gap:12px;align-items:center}
    .metric{padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.04);min-width:130px}
    .metric .label{font-size:12px;color:var(--muted)}
    .metric .value{font-weight:600;font-size:16px}
    #chart{height:420px;margin-top:12px}
    .buttons{display:flex;gap:6px}
    .btn--interval{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .btn--active{background:linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));box-shadow:0 6px 14px rgba(2,6,23,0.5)}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    @media (max-width:720px){.topline{flex-direction:column;align-items:flex-start}.metrics{flex-wrap:wrap}}
  </style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <h1>Crypto Trend — мини TradingView</h1>
          <div style="font-size:12px;color:var(--muted)">Лёгкий веб-клиент: график, EMA20/50, тренд и прогноз</div>
        </div>
      </div>
      <div class="controls">
        <select id="preset">
          <option value="bitcoin">BTC / Bitcoin</option>
          <option value="ethereum">ETH / Ethereum</option>
          <option value="solana">SOL / Solana</option>
          <option value="ripple">XRP / Ripple</option>
          <option value="chainlink">LINK / Chainlink</option>
        </select>
        <input id="search" type="text" placeholder="поиск монеты (CoinGecko ID или имя)" />
        <button id="btnSearch">Загрузить</button>
        <button id="themeToggle">Тема</button>
      </div>
    </header>

    <div class="card">
      <div class="topline">
        <div>
          <div style="font-size:13px;color:var(--muted)">Монета</div>
          <div style="font-weight:700;font-size:20px" id="coinTitle">Bitcoin (BTC)</div>
        </div>
        <div class="metrics">
          <div class="metric">
            <div class="label">Последняя цена</div>
            <div class="value" id="lastPrice">—</div>
          </div>
          <div class="metric">
            <div class="label">Тренд</div>
            <div class="value" id="trend">—</div>
          </div>
          <div class="metric">
            <div class="label">Сила</div>
            <div class="value" id="strength">—</div>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="buttons">
          <button class="btn--interval btn--active" data-days="1">1h</button>
          <button class="btn--interval" data-days="7">4h</button>
          <button class="btn--interval" data-days="30">1d</button>
        </div>
        <div style="font-size:13px;color:var(--muted)">Данные: CoinGecko через CORS-прокси · Обновление при загрузке</div>
      </div>

      <div id="chart"></div>
      <footer>Лёгкое одностраничное приложение — Fly.io онлайн</footer>
    </div>
  </div>

  <script src="https://unpkg.com/lightweight-charts@3.9.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const preset = document.getElementById('preset');
    const btnSearch = document.getElementById('btnSearch');
    const searchInput = document.getElementById('search');
    const coinTitle = document.getElementById('coinTitle');
    const lastPriceEl = document.getElementById('lastPrice');
    const trendEl = document.getElementById('trend');
    const strengthEl = document.getElementById('strength');
    const themeToggle = document.getElementById('themeToggle');

    let currentId = 'bitcoin';
    let chart = null;
    let lineSeries = null;
    let ema20Series = null;
    let ema50Series = null;

    function createChart(){
      const container = document.getElementById('chart');
      container.innerHTML = '';
      chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 420,
        layout: {backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg'), textColor: getComputedStyle(document.body).getPropertyValue('--text')},
        grid: {vertLines: {color: 'rgba(120,120,120,0.06)'}, horzLines: {color: 'rgba(120,120,120,0.06)'}}
      });
      lineSeries = chart.addLineSeries({lineWidth:2});
      ema20Series = chart.addLineSeries({lineWidth:1});
      ema50Series = chart.addLineSeries({lineWidth:1});
      window.addEventListener('resize', ()=> chart.applyOptions({width:container.clientWidth}));
    }

    function ema(values, period){
      const k = 2/(period+1);
      let emaArr = [];
      let prev = values[0];
      emaArr.push(prev);
      for(let i=1;i<values.length;i++){
        const v = values[i]*k + prev*(1-k);
        emaArr.push(v);
        prev = v;
      }
      return emaArr;
    }

    function formatPrice(p){
      if(p>=1) return p.toLocaleString(undefined,{maximumFractionDigits:2});
      return p.toPrecision(6);
    }

    async function fetchCoinData(id, days){
      const url = `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=${days}`)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Не удалось получить данные');
      return res.json();
    }

    async function loadAndRender(id, days){
      try{
        const raw = await fetchCoinData(id, days);
        const prices = raw.prices;
        if(!prices || prices.length===0) throw new Error('Нет данных');

        const series = prices.map(p=>({time: Math.floor(p[0]/1000), value: p[1]}));
        lineSeries.setData(series);

        const closes = prices.map(p=>p[1]);
        const ema20 = ema(closes, 20);
        const ema50 = ema(closes, 50);
        ema20Series.setData(ema20.map((v,i)=>({time: Math.floor(prices[i][0]/1000), value: v}))); 
        ema50Series.setData(ema50.map((v,i)=>({time: Math.floor(prices[i][0]/1000), value: v}))); 

        const last = closes[closes.length-1];
        lastPriceEl.textContent = '$' + formatPrice(last);
        coinTitle.textContent = `${id.charAt(0).toUpperCase()+id.slice(1)}`;

        const lastEma20 = ema20[ema20.length-1];
        const lastEma50 = ema50[ema50.length-1];
        const trend = lastEma20 > lastEma50 ? 'Восходящий ▲' : 'Нисходящий ▼';
        trendEl.textContent = trend;

        const pct = Math.abs((lastEma20-lastEma50)/lastEma50)*100;
        const strength = pct < 0.3 ? 'Слабый' : pct < 1 ? 'Средний' : 'Сильный';
        strengthEl.textContent = strength + ` (${pct.toFixed(2)}%)`;

      }catch(e){
        console.error('Ошибка:', e);
        alert('Ошибка: '+e.message);
      }
    }

    async function resolveCoin(query){
      query = query.trim().toLowerCase();
      if(!query) return null;
      try{
        const res = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(query)}`);
        const data = await res.json();
        if(data.coins && data.coins.length>0) return data.coins[0].id;
      }catch(e){console.warn(e)}
      return null;
    }

    document.querySelectorAll('.btn--interval').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.btn--interval').forEach(x=>x.classList.remove('btn--active'));
        b.classList.add('btn--active');
        loadAndRender(currentId, b.getAttribute('data-days'));
      });
    });

    preset.addEventListener('change', ()=>{
      currentId = preset.value;
      loadAndRender(currentId, document.querySelector('.btn--active').getAttribute('data-days'));
    });

    btnSearch.addEventListener('click', async ()=>{
      const q = searchInput.value.trim();
      if(!q) return alert('Введите запрос');
      const id = await resolveCoin(q) || q.toLowerCase();
      currentId = id;
      loadAndRender(currentId, document.querySelector('.btn--active').getAttribute('data-days'));
    });

    themeToggle.addEventListener('click', ()=>{
      const body = document.body;
      body.setAttribute('data-theme', body.getAttribute('data-theme')==='dark' ? 'light' : 'dark');
      createChart();
      loadAndRender(currentId, document.querySelector('.btn--active').getAttribute('data-days'));
    });

    (function(){
      createChart();
      loadAndRender(currentId, 1);
    })();
  </script>
</body>
</html>
